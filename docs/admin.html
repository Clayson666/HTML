<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transacciones - CreaMas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .table-img { 
      max-width: 100px;  
      max-height: 100px; 
      object-fit: cover; 
      cursor: pointer;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .table-wrapper { overflow-x: auto; }
  </style>
</head>
<body>
<div class="container mt-4">
  <h3>Listado de Transacciones</h3>
  <div class="table-wrapper mt-3">
    <table class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Vitamina</th>
          <th>Estado</th>
          <th>Fecha Creación</th>
          <th>Fecha Confirmación</th>
          <th>Fecha Pago</th>
          <th>Pago (Imagen)</th>
          <th>Admin Validado</th>
          <th>Notas</th>
          <th>Monto</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody id="transactionBody"></tbody>
    </table>
  </div>
</div>

<!-- Modal para ver imagen en grande -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <img id="modalImage" src="" style="max-width: 100%; max-height: 80vh; border-radius: 8px;"/>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const BASE_URL = 'https://esp32-74so-w.fly.dev/';

  function loadTransactions() {
    $.ajax({
      url: `${BASE_URL}/api/chat/transactions`,
      method: 'GET',
      dataType: 'json',
      success: function(transactions) {
        const $tbody = $('#transactionBody');
        $tbody.empty();
        transactions.forEach(tx => {
          const imgHtml = tx.paymentImage ? `<img src="${tx.paymentImage}" class="table-img"/>` : '';
          const adminVal = tx.adminValidado === true ? 'Sí' : 'No';
          const row = `
            <tr>
              <td>${tx.id}</td>
              <td>${tx.userId || ''}</td>
              <td>${tx.vitamina}</td>
              <td>${tx.estado}</td>
              <td>${tx.fechaCreacion || ''}</td>
              <td>${tx.fechaConfirmacion || ''}</td>
              <td>${tx.fechaPago || ''}</td>
              <td>${imgHtml}</td>
              <td>${adminVal}</td>
              <td>${tx.notas || ''}</td>
              <td>${tx.monto || ''}</td>
              <td>
                <button class="btn btn-success btn-sm validate-btn" data-id="${tx.id}" ${tx.adminValidado ? 'disabled' : ''}>
                  Validar pago
                </button>
              </td>
            </tr>
          `;
          $tbody.append(row);
        });
      },
      error: function(err) {
        console.error("Error cargando transacciones:", err);
      }
    });
  }

  // Validar pago
  $(document).on('click', '.validate-btn', function() {
    const txId = $(this).data('id');
    $.ajax({
      url: `${BASE_URL}/api/chat/transactions/${txId}/validate`,
      method: 'PUT',
      success: function() {
        alert(`Transacción ${txId} validada correctamente.`);
        loadTransactions(); // recargar tabla
      },
      error: function(err) {
        console.error("Error validando transacción:", err);
        alert("No se pudo validar la transacción.");
      }
    });
  });

  // Mostrar imagen en modal
  $(document).on('click', '.table-img', function() {
    const src = $(this).attr('src');
    $('#modalImage').attr('src', src);
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    modal.show();
  });

  $(document).ready(function() {
    loadTransactions();
  });
</script>
</body>
</html>
